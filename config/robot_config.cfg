<?xml version="1.0" encoding="utf-8" ?>
<qr name="quadruped_robot">
  <!-- Prepare resources for user aims to control the robot -->
  <!-- All of the hardwares list here, and it will be automatic instance -->
  <macro:prototype name="leg_proto" args="leg l0 l1 l2" >
    <tag>
      <yaw  auto_inst="middleware::Joint" leg="${leg}" jnt="yaw"  name="${leg}_yaw"  limits="${l0}" />
      <hip  auto_inst="middleware::Joint" leg="${leg}" jnt="hip"  name="${leg}_hip"  limits="${l1}" />
      <knee auto_inst="middleware::Joint" leg="${leg}" jnt="knee" name="${leg}_knee" limits="${l2}" />
      <td auto_inst="middleware::ForceSensor" leg="${leg}" />
    </tag>
  </macro:prototype>

  <res attr="resources">
    <prototype:leg_proto tag="fl" leg="fl"
        l0="-0.262618 0.228256" l1="-0.132295 0.766618" l2="-1.54981 -0.667767" />

    <prototype:leg_proto tag="hl" leg="hl"
        l0="-0.219662 0.285018" l1="-0.685826 0.191611" l2="0.655694 1.58068" />

    <prototype:leg_proto tag="fr" leg="fr"
        l0="-0.263249 0.170868" l1="-0.141008 0.8254"   l2="-1.63094 -0.785712" />

    <prototype:leg_proto tag="hr" leg="hr"
        l0="-0.301551 0.184721" l1="-0.779919 0.149673" l2="0.710949 1.64975" />

    <imu auto_inst="middleware::ImuSensor" />
    <power auto_inst="middleware::Power">
        <map_0 leg="fl" node_id="1" sub_node_id="1" />
        <map_1 leg="hl" node_id="2" sub_node_id="2" />
        <map_2 leg="fr" node_id="3" sub_node_id="2" />
        <map_3 leg="hr" node_id="4" sub_node_id="3" />
    </power>
  </res>
  <!-- About propagates, it will be automatic instance and addtion to PropagatesManager -->
  <!-- These objects as follow communication between the real robot directly -->
  <propa attr="propagates">
    <!--pcan_fake auto_inst="middleware::PcanChannelFake"
      output="/home/bibei/output" repeat="true" input="/home/bibei/input"
      channel="0x51" baud="500" type="0" port="0" interrupt="0" /-->
    <macro:property name="prefix" value="/home/bibei/Workspaces/qr_ws/src/qr-driver-0.2.9/Debug" />
    <pcan auto_inst="middleware::MotorPcan" bus="0x01" channel="0x51" baud="500" type="0" port="0" interrupt="0" hijack="false">
      <!-- gains="Kp Ki Kd" limits = "iMin iMax error_threshold" -->
      <pid_0 node_id="0x02" leg="fl" jnt="yaw" gains="-30 -1.00 0.01 -200 200" limits="-3000 3000 1672 1992" criterion="7 10" debug="true" path="${prefix}/pid" />
      <!-- 620 -->
      <pid_1 node_id="0x02" leg="fl" jnt="hip" gains="50 1.00 0.01 -200 200" limits="-3000 3000 2121 2707" criterion="7 10" debug="true" path="${prefix}/pid" />
      <!-- 650 -->
      <pid_2 node_id="0x02" leg="fl" jnt="knee" gains="30 0.50 0.01 -200 200" limits="-3000 3000 1786 2361" criterion="10 10" debug="true" path="${prefix}/pid" />
      <!-- 500 -->
      <pid_3 node_id="0x03" leg="hl" jnt="yaw" gains="50 1.00 0.01 -200 200" limits="-3000 3000 1996 2325" criterion="10 10" debug="true" path="${prefix}/pid" />
      <!-- 584 -->
      <pid_4 node_id="0x03" leg="hl" jnt="hip" gains="-30 -1.00 -0.01 -200 200" limits="-3000 3000 535 1107" criterion="7 10" debug="true" path="${prefix}/pid" />
      <!-- 661 -->
      <pid_5 node_id="0x03" leg="hl" jnt="knee" gains="-50 -1.00 -0.01 -200 200" limits="-3000 3000 873 1476" criterion="8 10" debug="true" path="${prefix}/pid" />
      <!-- 564 -->
      <pid_6 node_id="0x04" leg="fr" jnt="yaw" gains="50 1.00 0.01 -200 200" limits="-3000 3000 1893 2176" criterion="7 10" debug="true" path="${prefix}/pid" />
      <!-- 550 -->
      <pid_7 node_id="0x04" leg="fr" jnt="hip" gains="-40 -1.00 -0.01 -200 200" limits="-3000 3000 175 805" criterion="5 10" debug="true" path="${prefix}/pid" />
      <!-- 660 -->
      <pid_8 node_id="0x04" leg="fr" jnt="knee" gains="-45 -1.00 -0.01 -200 200" limits="-3000 3000 2286 2837" criterion="10 10" debug="true" path="${prefix}/pid" />
      <!-- 576 -->
      <pid_9 node_id="0x05" leg="hr" jnt="yaw" gains="-50 -1.00 -0.01 -200 200" limits="-3000 3000 1680 1997" criterion="7 10" debug="true" path="${prefix}/pid" />
      <!-- 571 -->
      <pid_10 node_id="0x05" leg="hr" jnt="hip" gains="50 1.00 0.01 -200 200" limits="-3000 3000 1738 2344" criterion="7 10" debug="true" path="${prefix}/pid" />
      <!-- 664 -->
      <pid_11 node_id="0x05" leg="hr" jnt="knee" gains="40 1.00 0.01 -200 200" limits="-3000 3000 2116 2728" criterion="7 10" debug="true" path="${prefix}/pid" />
      <!-- 606 -->
    </pcan>
        <usb auto_inst="middleware::ImuUsb" bus="0x02" channel="/dev/ttyUSB0" baud="115200" node_id="0x06" />
  </propa>
  <!-- Got the packet message from PropagateManager and update the information of hardware -->
  <!-- All of the nodes will be managed by HwManager which contains propagates-->
  <macro:prototype name="node_proto" args="leg id s0 s1 s2 off0 off1 off2" >
    <tag>
      <node auto_inst="middleware::LegNode" leg="${leg}" node_id="${id}">
        <joint_0 jnt="yaw" label="qr.res.${leg}.yaw"   scale="${s0}" offset="${off0}" />
        <joint_1 jnt="hip" label="qr.res.${leg}.hip"   scale="${s1}" offset="${off1}" />
        <joint_2 jnt="knee" label="qr.res.${leg}.knee" scale="${s2}" offset="${off2}" />
        <touchdown label="qr.res.${leg}.td" />
      </node>
    </tag>
  </macro:prototype>
  <nodes attr="hardwares">
    <prototype:node_proto tag="fl" leg="fl" id="0x02"
        s0="1" off0="16200" s1="-1" off1="23034" s2="1" off2="25180" />

    <prototype:node_proto tag="hl" leg="hl" id="0x03"
        s0="-1" off0="19176" s1="-1" off1="5316" s2="1" off2="3940" />

    <prototype:node_proto tag="fr" leg="fr" id="0x04"
        s0="1" off0="18146" s1="1" off1="2346" s2="-1" off2="15590" />

    <prototype:node_proto tag="hr" leg="hr" id="0x05"
        s0="-1" off0="15824" s1="1" off1="19744" s2="-1" off2="28050" />

    <imu_node   auto_inst="middleware::ImuNode"   node_id="0x06" label="qr.res.imu" />
    <power_node auto_inst="middleware::PowerNode" node_id="0x08" label="qr.res.power" />
  </nodes>

  <!-- User Layer -->
  <wrapper>
    <!-- The necessary parameters are asked by MiiRobot -->
    <robot mii_control="true" frequency="50" >
      <registry >
        <legs >
          <leg_0 leg="fl" order="knee hip yaw" command="fl-cmd" resource="leg-fl-pos leg-fl-vel leg-fl-tor" td_resource="leg-fl-td" />
          <leg_1 leg="fr" order="knee hip yaw" command="fr-cmd" resource="leg-fr-pos leg-fr-vel leg-fr-tor" td_resource="leg-fr-td" />
          <leg_2 leg="hl" order="knee hip yaw" command="hl-cmd" resource="leg-hl-pos leg-hl-vel leg-hl-tor" td_resource="leg-hl-td" />
          <leg_3 leg="hr" order="knee hip yaw" command="hr-cmd" resource="leg-hr-pos leg-hr-vel leg-hr-tor" td_resource="leg-hr-td" />
        </legs>

        <imu quaternion      ="imu-quat    imu-quat-cov"
             linear_acc      ="imu-lin-acc imu-lin_acc-cov"
             angular_vel     ="imu-ang-vel imu-ang_vel-cov" />
      </registry>
      <joints labels="qr.res.fl.yaw qr.res.fl.hip qr.res.fl.knee
                      qr.res.hl.yaw qr.res.hl.hip qr.res.hl.knee
                      qr.res.fr.yaw qr.res.fr.hip qr.res.fr.knee
                      qr.res.hr.yaw qr.res.hr.hip qr.res.hr.knee" />
      <touchdowns labels="qr.res.fl.td qr.res.hl.td qr.res.fr.td qr.res.hr.td" />
      <imu labels="qr.res.imu" />
    </robot>
        <!-- The necessary parameters are asked by RosWrapper -->
    <roswrapper>
      <touchdown_0 label="qr.res.fl.td" name="fl_td" frame_id="fl_foot" />
      <touchdown_1 label="qr.res.fr.td" name="fr_td" frame_id="fr_foot" />
      <touchdown_2 label="qr.res.hl.td" name="hl_td" frame_id="hl_foot" />
      <touchdown_3 label="qr.res.hr.td" name="hr_td" frame_id="hr_foot" />
      <imu label="qr.res.imu" name="imu" frame_id="body" />
    </roswrapper>
  </wrapper>
</qr>
